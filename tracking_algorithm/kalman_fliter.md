# **Kalman Fliter**
*卡尔曼滤波（Kalman Filter，KF）以贝叶斯滤波为理论基础，并通过:*
- 假设 **状态量随机变量（以下简称状态量）**、**观测量**均服从**正态分布**
- 假设 **过程噪声**、**观测噪声**均服从**均值为 0 的正态分布**，- 假设 **状态转移函数**和**观测函数**均为**线性函数**，实现对连续型随机过程的递推状态估计。简言之，卡尔曼滤波是在贝叶斯滤波框架下求解线性高斯问题。

## 认识卡尔曼滤波

假设有一个小机器人在一片树林，它需要**准确的知道自己的位置**以便能够**向目标点移动**。

例如，我们可以用一个状态向量（位置和速度）来表述 $k$ 时刻的状态：

$$
\vec x_k = (\vec p, \vec v)
$$

注意**状态向量**可以是任何东西，只要能够表示系统当前状态的量，都可以放在状态向量中。在本例子中，状态向量是位置和速度，当然滤波的状态量可以是油罐的油量、发动机的温度或者手指在触摸板上的位置，万物都可以模型化，就意味着万物均可卡尔曼。

假设机器人是带有一个精度 $10cm$ 的GPS定位，当时实际情况中，这个精度无法满足机器人的定位需求，森林里面有遮挡（树木盖住信号）、路况复杂有悬崖，精度不够容易掉下去， 因此仅仅依靠GPS定位信息无法满足机器人的定位需求。

我们同时知道机器人的运动特性，机器人接受到控制指令后，会根据指令控制轮子上的电机调整相应转速，同时，机器人也会根据自身的运动状态推算出自己当前的朝向，理论上来说，是可以根据机器人的**轮子转速**来更新机器人的位置和朝向信息的。然而实际情况是，机器人的运动会受到各种影响（风、轮子打滑）或者道路过于崎岖都会对机器人运动状态的估算造成影响。因此，不能单纯的使用轮子转动的圈数来表示机器人行驶过的路程，同样的，也不能单纯的用机器人的轮子去推算机器人当前位置的朝向信息。

目前可以通过两种方式来确定机器人的位置信息：

第一种，通过机器人自带的GPS定位，但是这种方式噪声太大，定位精度不够，

第二种，通过机器人自身的轮速信息，对机器人现有位置进行预测，这种方式，会因为外界环境的影响，造成对位置的估算不准确。

综合来看，机器人的位置信息，可以有两种方式获得，

1. 通过传感器直接观测，但是传感器测量有误差

2. 通过机器人运动学方程进行推算，但是会有干扰，会导致机器人位置估算有误差，误差会随着机器人的行驶不断积累，位置精度也会很大。

那么有没有一种方式，能让我们利用所有的可用信息，来提高机器人的定位信息呢？ 卡尔曼可以计算最有估计。

## 卡尔曼滤波原理

用一个状态向量表示当前机器人的状态，状态量包括位置和速度两个信息，

$$
\vec x = 
\left[ \begin {array}{}
p \\
v
\end{array}\right]
$$

![image](https://github.com/CaiRugou/Autonomous/blob/main/img/kalman.png)

高斯分布的中心 $\mu$ 就是图中的 $\hat x_k$ :

```math
\hat x_k = 
\left [  \begin {array}{}

position \\

velocity

\end {array} \right]
```

对于方差 $\sigma ^2$ 也就是图中的椭圆的范围， 因为我们有两个变量，所以可以用一个协方差矩阵来表示。

```math
P_k = 
\left [ \begin {array} {}

\sum_{pp} & \sum_{pv} \\

\sum_{vp} & \sum_{vv}

\end {array} \right]
```

所以机器人的真是状态可能就位于上图椭圆的范围内，位于圆心的概率最大。

## 预测下一个位置的系统状态和系统误差

这里我们假设这些这些状态量满足高斯分布，

接下来我们需要通过机器人的当前状态，运用物理学的知识来预测下它的下一个状态，通过简单的物理学知识，通过 $k-1$ 时刻的位置和速度，可以推测下一个时刻的状态为：

$$
p_k = p_{k-1} + \Delta t  \ v_{k-1}
$$

$$
v_k = \  v_{k-1}
$$

写成矩阵形式：

```math
\hat x_k = 

\left  [ \begin {array} {}

1 & \Delta t \\

0 & \  1

\end {array} \right ] \hat x_{k-1}

= F_k \hat x_{k-1}
```

此处的 $F_k$ 就是状态转移矩阵，该矩阵为常量矩阵，通过计算后，得到的**结果仍然满足高斯分布**。

机器人的系统误差通过协方差矩阵来表示，对于协方差矩阵有如下特性：

$$
Cov(x) = \sum \\
Cov(Ax) = A\sum A^T
$$

那么我们所预测的机器人下一个时刻的状态误差为：

$$
P_K = F_kP_{k-1}F_k^T
$$

## 考虑系统内部控制

为了能够让机器人到达任何地方，毫无疑问我们需要对它进行控制，比如加速减速，假设某个时刻我们给机器人施加一个加速度 $a$ , 那么下一个时刻的位置和速度则应该为

```math
p_k = p_{k-1} + \Delta t  \ v_{k-1} + {1 \over 2}a \Delta t^2 
```

```math
v_k =  \ v_{k-1} + a \Delta t
```

因此我们的状态预测方程更新为：

```math
\hat x_k = F_k \hat x_{k-1} + 
\left  [ \begin {array}{}
{\Delta t^2} \over 2 \\

\Delta t

\end {array} \right] a \\

= F_k \hat x_{k-1} + B_ku_k
```

在新的方程中 $B_k$ 称为**状态控制矩阵**， $u_k$ 称为**状态控制向量**， 含义很明显，前者表明的是加速和减速如何改变机器人的状态，后者是表示控制力度和方向。

## 考虑系统外部影响

外界可能有很多影响因素，导致我们对机器人实施的控制并不总是按照我们的指令，有时路面湿滑轮子打滑等因素，**我们假设这种外部影响是一个符合高斯分布** 服从分布 $N(0, Q_k)$ ,至此我们就能得到Kalman滤波中完整的**状态预测方程**：

```math

\hat x_k = F_k \hat x_{k-1} + B_ku_k + 0 \\
```

```math
P_k = F_kP_{k-1}F^T_k + Q_k

```

## 传感器观测量

前面几个步骤，已经对机器人做了缜密的预测，此时我们需要考虑机器人安装的传感器能够观测到什么值，当前状态和观测的传感器数据具有特定的关系，假设这个关系通过矩阵表示为 $H_k$ ，**这里我们认为 $H_k$ 是常数矩阵关系**， 如下图所示：

![image](https://github.com/CaiRugou/Autonomous/blob/main/img/transform.png)

基于前面预测的机器人状态，我们可以得到预测状态量转换为传感器单位量后的体现（或者理解为在预测坐标系下的预测值 转为 传感器坐标系下的值）：

$$
\mu = H_k \hat x_k
$$

$$
\sum = H_kP_kH_k^T
$$

因此，我们就完成了对观测值的预测，**预测结果服从高斯分布**：

$$
(\vec \mu _0 , \sum _0) = (H_k \hat x_k , H_kP_kH_k^T)
$$


## 实际测量结果

现在我们已经在传感器单位下预测了观测值，和传感器实际测量结果可能仍然存在差距。
这里我们假设传感器实际测量存在一个白噪声**符合均值为 $0$ 协方差矩阵为 $R_k$ 的高斯分布**：

$$
N(0, R_k)
$$

也就是说对于观测的机器人，我们认为其实际观测结果**服从高斯分布**：

$$
(\vec \mu _1 , \sum _1) = (z_k, R_k)
$$
